<!-- <div *ngIf="loading()" style="font-weight:bold; margin:10px 0;">
  Loading...
</div>


<div *ngIf="errorMessage()" style="color:red; margin:10px 0;">
  {{ errorMessage() }}
</div>


<div *ngIf="!loading() && !errorMessage()">


  <div *ngFor="let group of groupedData()" style="margin-bottom:30px;">


    <h2 style="
      background:#f4f4f4;
      padding:10px;
      border-left:5px solid #1976d2;">
      {{ group.name }}
    </h2>


    <div *ngFor="let item of group.items"
         class="card"
         style="margin-bottom:20px; padding:10px; border:1px solid #ccc; border-radius:5px;">

      <h3>State: {{ item.state }}</h3>


      <table border="1" width="100%" *ngIf="item.differences && item.differences.length > 0">
        <tr>
          <th>Field</th>
          <th style="color:green;">Draft</th>
          <th style="color:red;">Actual</th>
        </tr>

        <tr *ngFor="let diff of item.differences">
          <td>{{ diff.field }}</td>


          <td style="color: green; vertical-align: top;">
            <ng-container *ngIf="isObject(diff.draftValue); else draftPrimitive">

              <div *ngFor="let kv of toKeyValueArray(diff.draftValue)" style="margin-left:5px;">
                <strong>{{ kv.key }}:</strong>

                <ng-container *ngIf="isObject(kv.value) || isArray(kv.value); else draftValuePrimitive">
                  <div *ngFor="let sub of kv.value" style="margin-left:15px;">
                    <strong>{{ sub.key }}:</strong> {{ sub.value }}
                  </div>
                </ng-container>

                <ng-template #draftValuePrimitive>
                  {{ kv.value }}
                </ng-template>

              </div>

            </ng-container>

            <ng-template #draftPrimitive>
              {{ diff.draftValue ?? 'null'}}
            </ng-template>
          </td>


          <td style="color: red; vertical-align: top;">
            <ng-container *ngIf="isObject(diff.actualValue); else actualPrimitive">

              <div *ngFor="let kv of diff.actualValue | keyvalue" style="margin-left:5px;">
                <strong>{{ kv.key }}:</strong>

                <ng-container *ngIf="isObject(kv.value) ||isArray(kv.value); else actualValuePrimitive">
                  <div *ngFor="let sub of kv.value | keyvalue" style="margin-left:15px;">
                    <strong>{{ sub.key }}:</strong> {{ sub.value }}
                  </div>
                </ng-container>

                <ng-template #actualValuePrimitive>
                  {{ kv.value }}
                </ng-template>

              </div>

            </ng-container>

            <ng-template #actualPrimitive>
              {{ diff.actualValue ?? 'null'}}
            </ng-template>
          </td>

        </tr>
      </table>


      <p *ngIf="item.differences?.length === 0"
         style="color: gray; font-style: italic;">
        No Differences
      </p>

    </div>

  </div>

</div> -->



<!-- <button (click)="fetchData()">Load Differences</button>

<div *ngIf="loading()">Loading...</div>
<div *ngIf="error()">{{ error() }}</div>

<div *ngFor="let group of groupedDiffs()">

  <h2 style="color: darkblue;">
    {{ group.appArtifactName }}
  </h2>

  <div *ngFor="let diff of group.items">

    <h4>State: {{ diff.state }}</h4>

    <div *ngFor="let item of diff.differences | keyvalue">

      <h5>{{ item.key }}</h5>

      <div style="display:flex; gap:40px; margin-bottom:10px;">

        <div>
          <strong>Draft</strong>
          <pre>{{ item.value.draft | json }}</pre>
        </div>

        <div>
          <strong>Actual</strong>
          <pre>{{ item.value.actual | json }}</pre>
        </div>

      </div>

      <hr>
    </div>

  </div>

</div> -->




<!--
<button (click)="loadData()">Load Differences</button>

<div *ngIf="loading()">Loading...</div>

<div *ngIf="errorMessage()" style="color:red">
  {{ errorMessage() }}
</div>

<div *ngFor="let group of objectKeys(groupedData())">

  <h2 style="margin-top:30px; border-bottom:2px solid #333;">
    {{ group }}
  </h2>

  <div *ngFor="let record of groupedData()[group]">

    <h4>State: {{ record.state }}</h4>

    <table border="1" width="100%" cellspacing="0" cellpadding="8">

      <thead>
        <tr>
          <th width="40%">Field Name</th>
          <th width="20%">Type</th>
          <th width="40%">Value</th>
        </tr>
      </thead>

      <tbody>


        <tr *ngIf="(record.differences | keyvalue).length === 0">
          <td colspan="3" style="text-align:center;">
            No Difference
          </td>
        </tr>


        <tr *ngFor="let item of record.differences | keyvalue">

          <td>
            {{ item.key }}
          </td>


          <td>
            {{
              item.key.includes('(Draft)') ? 'Draft' :
              item.key.includes('(Actual)') ? 'Actual' :
              record.state === 'INSERT' ? 'Inserted' :
              record.state === 'DELETE' ? 'Deleted' :
              'Changed'
            }}
          </td>

          <td>
            {{ item.value ?? 'null' }}
          </td>

        </tr>

      </tbody>

    </table>

  </div>

</div> -->







@if (loading()) {
<div class="loading">Loading...</div>
}

@if (error()) {
<div class="error">{{ error() }}</div>
}

<!-- Loop by appArtifactName -->
@for (artifact of objectKeys(groupedData()); track artifact) {

<div class="artifact-block">

  <h2 class="artifact-title">
    {{ artifact }}
  </h2>

  <!-- Loop each record -->
  @for (item of groupedData()[artifact]; track $index) {

  <div class="record-card">

    <div class="record-header">
      <span class="state-label">State:</span>
      <span class="state-value">{{ item.state }}</span>
    </div>

    <table class="diff-table">

      <thead>
        <tr>
          <th>Field</th>
          <th>Draft</th>
          <th>Actual</th>
        </tr>
      </thead>

      <tbody>

        <!-- No Difference -->
        @if (item.differences.length === 0) {
        <tr>
          <td colspan="3" class="no-diff-cell">
            <div><strong>Draft ID:</strong> {{ item.draftId }}</div>
            <div class="no-diff-text">No Difference</div>
          </td>
        </tr>
        }

        <!-- Differences -->
        @for (row of item.differences; track $index) {

        <tr>
          <td class="field-cell">
            {{ row.field }}
          </td>

          <td class="draft-cell">
            <pre>
{{ row.draft !== null && row.draft !== undefined
    ? (typeof row.draft === 'object' ? (row.draft | json) : row.draft)
    : 'null' }}
                  </pre>
          </td>

          <td class="actual-cell">
            <pre>
{{ row.actual !== null && row.actual !== undefined
    ? (typeof row.actual === 'object' ? (row.actual | json) : row.actual)
    : 'null' }}
                  </pre>
          </td>
        </tr>

        }

      </tbody>

    </table>

  </div>

  }

</div>

}
